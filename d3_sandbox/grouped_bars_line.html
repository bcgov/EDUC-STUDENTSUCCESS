<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>

    <style>
        #distContainer {
            display: flex;
            justify-content: space-around;
        }

        .distBtn {
            padding: 0.25rem 1rem;
            border: 2px solid #38598a;
            border-radius: 50px;
            color: #38598a;
            font-weight: medium;
            cursor: pointer;
        }

        .distBtn:hover {
            color: #fff;
            background: #38598a;
            box-shadow: 0 6px 8px 0 rgba(0, 0, 0, 0.14), 0 9px 10px 0 rgba(0, 0, 0, 0.09);
            transform: translateY(-0.025em);
            transition: .3s ease;
        }

        .selectedDist {
            font-weight: bold;
            color: white;
            background: #38598a;
            box-shadow: 0 3px 4px 0 rgba(0, 0, 0, 0.07), 0 4px 5px 0 rgba(0, 0, 0, 0.05);
        }

        #lineContainer {
            display: inline-block;
            position: relative;
            width: 100%;
            padding-bottom: 30rem;
            vertical-align: top;
            overflow: hidden;
        }

        .svg-content {
            display: inline-block;
            position: absolute;
            top: 0;
            left: 0;
        }

        .bar {
            stroke: none;
        }

        .bar:hover {
            fill: rgba(0, 38, 99, 0.7);
        }

        .label {
            fill: white;
            font: 15px;
            font-weight: 400;
            text-anchor: middle;
        }

        .line {
            fill: none;
            stroke: #002663;
            stroke-width: 3;
        }

        .dot {
            fill: #002663;
            stroke: #fff;
        }

        #line_tt {
            background: #ccc;
            padding: 10px 10px;
            border-radius: 3px;
            color: #494949;
        }

        #graph {
            max-width: 700px;
        }
    </style>
</head>

<body>
    <div class="container my-5" id="graph">
        <div class="row">
            <div class="col-sm-12 col-md-4">
                <h2 class="mb-3">Districts with the highest net migration growth</h2>
                <h4 id="distName">SD-05 Southeast Kootenay</h4>
                <p id="distInfo">Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor
                    incididunt ut labore et
                    dolore
                    magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex
                    ea
                    commodo
                    consequat. Duis aute irure dolor in reprehenderit.</p>
            </div>
            <div class="col-sm-12 col-md-8">
                <div id="distContainer"></div>
                <div id="lineContainer"></div>
            </div>
        </div>
    </div>
</body>

<script src="//d3js.org/d3.v4.min.js"></script>
<script>
    //line_margin 
    let line_margin = { top: 50, right: 50, bottom: 50, left: 50 };

    //height and width
    let line_height = 400 - line_margin.top - line_margin.bottom;
    let line_width = 600 - line_margin.left - line_margin.right;

    let formatC = d3.format(",.0f");
    // let formatPercent = d3.format(".0%");

    //parseDate is used to covert string into year format from the csv file 
    let parseDate = d3.timeParse('%Y');

    //scales
    let line_xScale = d3.scalePoint().range([0, line_width]).padding(0.5);;


    //x1, usedto create the group (grouped bars) elements
    // 0.1 is the padding added to offset the band from the edge of the interval
    let bar_xScale1 = d3.scaleBand()
        .rangeRound([0, line_width])
        .padding(.2)
        .paddingInner(.2);

    //x2, create the smaller elements inside the group
    // domain and range will be set later
    let bar_xScale2 = d3.scaleBand()
        .padding(0.1);

    let line_yScale = d3.scaleLinear()
        .range([line_height, 0]);

    /* This scale produces negative output for negatve input */
    let bar_yScale_neg = d3.scaleLinear()
        .range([0, line_height]);

    //a reversed range, and a larger domain to accomodate negaive values.
    let bar_yScale = d3.scaleLinear();

    //color scale
    let color_scale = d3.scaleOrdinal()
        .range(['#fde6ba', '#96c0e6', '#ef8a62', '#d8beda']);

    let bar_xAxis = d3.axisBottom()
        .scale(bar_xScale1);

    let line_yAxis = d3.axisRight()
        .scale(line_yScale);

    let bar_yAxis = d3.axisLeft()
        .scale(bar_yScale);


    //lines
    let growthLine = d3.line()
        .x(function (d) {
            return line_xScale(d.School_Year);
        })
        .y(function (d) {
            return line_yScale(d.FORECAST_ENROLMENT);
        })
        .curve(d3.curveMonotoneX); //smooth the line


    //distirct controls
    let district = 'line_SD05';
    let districts = ["SD05", "SD06", "SD08", "SD10", "SD19"];
    let defaultPageLoad = true;

    //create district btns
    let distBtn = d3.select('#distContainer')
        .selectAll('div')
        .data(districts)
        .enter()
        .append('div')
        .attr('id', function (d, i) {
            return 'line_' + d;
        })
        .text(function (d) {
            return d;
        })
        .attr('class', function (d) { //adding a condition to higlight selected btn
            if ('line_' + d == district) {
                return 'distBtn selectedDist';
            } else {
                return 'distBtn';
            }
        });

    //canvas
    let line_svg = d3.select('#lineContainer').append('svg')
        .attr("preserveAspectRatio", "xMinYMin meet")  // This forces uniform scaling for both the x and y, aligning the midpoint of the SVG object with the midpoint of the container element.
        .attr("viewBox", "0 0 600 600") //defines the aspect ratio, the inner scaling of object lengths and coordinates
        .attr('class', 'svg-content');

    let line_chartGroup = line_svg.append('g')
        .attr('class', 'chartGroup')
        .attr('transform', 'translate(' + line_margin.left + ',' + line_margin.top + ')');


    //initialize html tooltip
    let tooltip_line = d3.select("#lineContainer")
        .append("div")
        .attr("id", "line_tt")
        .style("z-index", "10")
        .style("position", "absolute")
        .style("visibility", "hidden");




    d3.csv('data/grouped.csv', function (error, data) {
        if (error) {
            throw error;
        }

        let districtData = data.filter(function (d) { return d.DISTRICT == district.substring(7, district.length) });

        console.log(districtData);

        //get the array of keys (drivers)
        let driverNames = d3.keys(data[0]).filter(function (key) {
            if (key !== 'DISTRICT' && key !== 'School_Year' && key !== 'FORECAST_ENROLMENT') {
                return key
            }
        });

        console.log(driverNames);

        //for each js object, generate a new key called drivers
        // value is an array of js objects each has driver name and value

        //because grouped bar chart
        //data must be grouped by year, inside data grouped by drivers 

        districtData.forEach(function (d) {
            d.drivers = driverNames.map(function (name) {
                return {
                    name: name,
                    value: +d[name]
                };
            });
        });


        //set aixs
        line_xScale.domain(districtData.map(function (d) { return d.School_Year; }));
        bar_xScale1.domain(districtData.map(function (d) { return d.School_Year; }));
        // set x2 axis within the bar group
        bar_xScale2.domain(driverNames).rangeRound([0, bar_xScale1.bandwidth()]);
        line_yScale.domain([0, d3.max(districtData, function (d) { return d.FORECAST_ENROLMENT; })]);


        bar_yScale_neg.domain([0, d3.max(districtData, function (d) {
            return d3.max(d.drivers, function (d) {
                return d.value;
            })
        })
        ]);

        // get min and max from multi columns (drivers)
        //first find out lowest/highest population amount throught the years then finds out largest number of drivers of that year
        bar_yScale.domain([d3.min(districtData, function (d) {
            return d3.min(d.drivers, function (d) {
                return d.value;
            });
        }), d3.max(districtData, function (d) {
            return d3.max(d.drivers, function (d) {
                return d.value;
            });
        })])
            .range([line_height - bar_yScale_neg(d3.min(districtData, function (d) {
                return d3.min(d.drivers, function (d) {
                    return d.value;
                })
            })), 0]);

        // bar_yScale.domain([Math.min(d3.min(districtData, function (d) { return d.DEMOGRAPHICS }),
        //     d3.min(districtData, function (d) { return d.MIGRATION }),
        //     d3.min(districtData, function (d) { return d.RETENTION }),
        //     d3.min(districtData, function (d) { return d.INDEPENDENT })),
        // Math.max(d3.max(districtData, function (d) { return d.DEMOGRAPHICS }),
        //     d3.max(districtData, function (d) { return d.MIGRATION }),
        //     d3.max(districtData, function (d) { return d.RETENTION }),
        //     d3.max(districtData, function (d) { return d.INDEPENDENT }))]);

        //line y axis
        line_chartGroup.append('g')
            .attr('class', 'yAxis')
            .attr('transform', "translate( " + line_width + ", 0 )")
            .call(line_yAxis);

        //bar y axis
        line_chartGroup.append('g')
            .attr('class', 'yAxis2')
            .call(bar_yAxis)
            .append('text')
            .attr('transform', 'rotate(-90)')
            .attr('y', 6)
            .attr('dy', '.8em')
            .style('text-anchor', 'end')
            .text('Driver impact');

        //bar x axis
        line_chartGroup.append('g')
            .attr('transform', 'translate(0,' + line_height * 1.7 + ')')
            .attr('class', 'xAxis')
            .call(bar_xAxis);


        //year group
        let yrGroup = line_chartGroup.selectAll('.year')
            .data(districtData)
            .enter()
            .append('g')
            .attr('class', 'year')
            .attr('transform', function (d) {
                return 'translate(' + bar_xScale1(d.School_Year) + ',0)';
            });



        //draw grouped bars
        yrGroup.selectAll('.bar')
            .data(function (d) { return d.drivers; })
            .enter().append('rect')
            .attr('class', 'bar')
            .attr('x', function (d) { return bar_xScale2(d.name); })
            .attr('width', function (d) { return bar_xScale2.bandwidth(); })
            .attr('y', function (d) { return line_height - Math.max(0, bar_yScale_neg(d.value)); })
            .attr('height', function (d) { return Math.abs(bar_yScale_neg(d.value)) })
            .style('fill', function (d) { return color_scale(d.name); });

        //bar labels
        // let labels = line_chartGroup.selectAll(".label")
        //     .data(districtData)
        //     .enter()
        //     .append("text")
        //     .attr("class", "label")
        //     .attr("x", (function (d) { return bar_xScale(d.Year) + bar_xScale.bandwidth() / 2; }))
        //     .attr("y", function (d) { return line_height - bar_yScale(d.NetMigration) + 1; })
        //     .attr("dy", ".75em")
        //     .text(function (d) { return d.NetMigration; });

        //draw line graph
        let linegraph = line_chartGroup.append('path')
            .datum(districtData)
            .attr('class', 'line')
            .attr('d', growthLine);


        let dots = line_chartGroup.selectAll(".dot")
            .data(districtData)
            .enter().append("circle") // Uses the enter().append() method
            .attr("class", "dot") // Assign a class for styling
            .attr("cx", function (d) { return line_xScale(d.School_Year); })
            .attr("cy", function (d) { return line_yScale(d.FORECAST_ENROLMENT) })
            .attr("r", 5)
            .on("mouseenter", function (d) {
                //toolOver is the event handler
                console.log(d);
                return line_toolOver(d, this);
            })
            .on("mousemove", function (d) {
                //gets mouse coordinates on screen
                var m = d3.mouse(this);
                mx = m[0];
                my = m[1];
                console.log(mx, my);

                return line_toolMove(mx, my, d);
            })
            .on("mouseleave", function (d) {
                return line_toolOut(d, this);
            });

        //     distBtn.on('click', function (d) {
        //         //remove all element with .selected class
        //         d3.selectAll('.selectedDist')
        //             .classed('selectedDist', false);
        //         //add selected class to button being clicked
        //         d3.select(this)
        //             .classed('selectedDist', true);
        //         //set district 
        //         district = d;
        //         console.log(district);

        //         districtData = data.filter(function (d) { return d.Abbrv == district });

        //         distName = districtData[0].District;

        //         d3.select('#distName').text(district + ' ' + distName);

        //         districtData.forEach(function (d) {
        //             d.NetMigration = +d.NetMigration;
        //             d.PercentChange = +d.PercentChange;
        //         });

        //         line_xScale.domain(districtData.map(function (d) { return d.Year; }));
        //         bar_xScale.domain(districtData.map(function (d) { return d.Year }));
        //         line_yScale.domain([0, d3.max(districtData, function (d) { return d.PercentChange })]).nice();
        //         bar_yScale.domain([d3.min(districtData, function (d) { return d.NetMigration }) - 20, d3.max(districtData, function (d) { return d.NetMigration }) + 20]);


        //         bargraph.data(districtData)
        //             .transition()
        //             .duration(1500)
        //             .attr('y', function (d) { return line_height - bar_yScale(d.NetMigration); })
        //             .attr('height', function (d) { return bar_yScale(d.NetMigration); });


        //         linegraph.datum(districtData)
        //             .transition()
        //             .duration(1500)
        //             .attr('d', growthLine);

        //         console.log(growthLine(districtData));
        //         dots.data(districtData)
        //             .transition()
        //             .duration(1500)
        //             .attr("cx", function (d) { return line_xScale(d.Year) })
        //             .attr("cy", function (d) { return line_yScale(d.PercentChange) });


        //         line_chartGroup.select('.yAxis')
        //             .transition()
        //             .duration(1600)
        //             .call(line_yAxis);

        //         line_chartGroup.select('.yAxis2')
        //             .transition()
        //             .duration(1600)
        //             .call(bar_yAxis);
        //     });

        

         });

    function line_toolOver(v, thepath) {
        d3.select(thepath)
            //in v4+ use the "long forms"
            .attr("style", "fill:#FCBA19")
            .attr("cursor", "pointer");
        return tooltip_line.style("visibility", "visible");
    };

    function line_toolOut(m, thepath) {
        d3.select(thepath)
            .attr("style", "fill:#002663")
            .attr("cursor", "pointer");
        return tooltip_line.style("visibility", "hidden");
    };


    function line_toolMove(mx, my, data) {
        //create the tooltip, style it and inject info
        if (+data.School_Year > 2018) {
            return tooltip_line.style("top", my + - 20 + "px")
                .style("left", mx - 10 + "px")
                .html("Forecast Enrolment: <b>" + Math.round(data.FORECAST_ENROLMENT));
        } else {
            return tooltip_line.style("top", my + - 20 + "px")
                .style("left", mx - 10 + "px")
                .html("Total Enrolment: <b>" + Math.round(data.FORECAST_ENROLMENT));
        }
    };
</script>

</html>